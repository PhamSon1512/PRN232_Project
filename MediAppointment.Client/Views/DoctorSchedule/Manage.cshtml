@model MediAppointment.Client.Models.DoctorSchedule.DoctorScheduleManagementViewModel
@{
    ViewData["Title"] = "Đăng ký lịch làm việc";
    Layout = "~/Views/Shared/_DoctorLayout.cshtml";
    
    var weekDates = new List<DateTime>();
    if (Model.Year > 0 && Model.Week > 0)
    {
        var jan1 = new DateTime(Model.Year, 1, 1);
        var daysOffset = (int)DayOfWeek.Monday - (int)jan1.DayOfWeek;
        var firstMonday = jan1.AddDays(daysOffset);
        var startOfWeek = firstMonday.AddDays((Model.Week - 1) * 7);
        weekDates = Enumerable.Range(0, 7).Select(i => startOfWeek.AddDays(i)).ToList();
    }
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-calendar-check"></i> Đăng ký lịch làm việc</h3>
                </div>
                <div class="card-body">
                    <!-- Alert Messages -->
                    <div id="alertContainer"></div>

                    <!-- Alert Messages from TempData -->
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["InfoMessage"] != null)
                    {
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            @TempData["InfoMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- Filters -->
                    <form id="filterForm" method="post" action="@Url.Action("Manage")">
                        @Html.AntiForgeryToken()
                        <div class="row mb-4">
                            <div class="col-md-2">
                                <label class="form-label">Khoa <span class="text-danger">*</span></label>
                                <select name="departmentId" id="departmentSelect" class="form-select" required>
                                    <option value="">-- Chọn khoa --</option>
                                    @foreach (var dept in Model.Departments)
                                    {
                                        <option value="@dept.Id" selected="@(Model.DepartmentId == dept.Id ? "selected" : null)">
                                            @dept.Name
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Phòng <span class="text-danger">*</span></label>
                                <select name="roomId" id="roomSelect" class="form-select" required>
                                    <option value="">-- Chọn phòng --</option>
                                    @foreach (var room in Model.Rooms.Where(r => r.DepartmentId == Model.DepartmentId))
                                    {
                                        <option value="@room.Id" 
                                                data-department="@room.DepartmentId"
                                                selected="@(Model.RoomId == room.Id ? "selected" : null)">
                                            @room.Name
                                        </option>
                                    }
                                </select>
                                
                                <!-- Hidden data for JavaScript -->
                                <script type="application/json" id="allRoomsData">
                                    @Html.Raw(Json.Serialize(Model.Rooms.Select(r => new { 
                                        id = r.Id.ToString(), 
                                        name = r.Name, 
                                        departmentId = r.DepartmentId.ToString() 
                                    })))
                                </script>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Năm <span class="text-danger">*</span></label>
                                <select name="year" id="yearSelect" class="form-select" required>
                                    @foreach (var year in Model.AvailableYears)
                                    {
                                        <option value="@year" selected="@(Model.Year == year ? "selected" : null)">
                                            @year
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Tuần <span class="text-danger">*</span></label>
                                <select name="week" id="weekSelect" class="form-select" required>
                                    @foreach (var week in Model.AvailableWeeks)
                                    {
                                        <option value="@week" selected="@(Model.Week == week ? "selected" : null)">
                                            Tuần @week
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-flex gap-2 align-items-end" style="height: 38px;">
                                    <button type="submit" class="btn btn-primary h-100 w-100">
                                        <i class="bi bi-search"></i> Tải lịch làm việc
                                    </button>
                                </div>
                            </div>
                        </div>

                        @if (weekDates.Any())
                        {
                        }
                    </form>

                    <!-- Schedule Grid -->
                    @if (weekDates.Any())
                    {
                        <div class="row mb-3">
                            <div class="col-12">
                                <h5 class="text-primary">
                                    <i class="bi bi-calendar-week"></i> 
                                    Tuần @Model.Week, năm @Model.Year 
                                    (@weekDates.First().ToString("dd/MM") - @weekDates.Last().ToString("dd/MM"))
                                </h5>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="15%" class="text-center">Ca làm việc</th>
                                        @foreach (var date in weekDates)
                                        {
                                            <th width="12%" class="text-center">
                                                <div>@date.ToString("ddd", new System.Globalization.CultureInfo("vi-VN"))</div>
                                                <small class="text-muted">@date.ToString("dd/MM")</small>
                                            </th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Morning shift -->
                                    <tr>
                                        <td class="fw-bold bg-light text-center">
                                            <div>Ca sáng</div>
                                            <small class="text-muted">07:00 - 11:00</small>
                                        </td>
                                        @foreach (var date in weekDates)
                                        {
                                            <td class="text-center">
                                                @{
                                                    var morningSlots = Model.WeeklySchedule.TryGetValue(date.Date, out var slotsMorning) 
                                                        ? slotsMorning.Where(s => s.Period == "morning").ToList() 
                                                        : new List<MediAppointment.Client.Models.DoctorSchedule.ScheduleSlot>();
                                                }
                                                
                                                <div class="schedule-cell" data-date="@date.ToString("yyyy-MM-dd")" data-period="morning">
                                                    @if (morningSlots.Any())
                                                    {
                                                        <div class="registered-slots">
                                                            <div class="text-center mb-3">
                                                                <span class="badge bg-success" style="font-size: 1rem; padding: 8px 12px;">
                                                                    <i class="bi bi-check-circle-fill"></i> Đã đăng ký
                                                                </span>
                                                            </div>
                                                            <form method="post" action="@Url.Action("CancelSchedule")" class="w-100">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="roomId" value="@Model.RoomId" />
                                                                <input type="hidden" name="date" value="@date.ToString("yyyy-MM-dd")" />
                                                                <input type="hidden" name="period" value="morning" />
                                                                <input type="hidden" name="year" value="@Model.Year" />
                                                                <input type="hidden" name="week" value="@Model.Week" />
                                                                <input type="hidden" name="departmentId" value="@Model.DepartmentId" />
                                                                <button type="submit" class="btn btn-sm btn-outline-danger w-100"
                                                                        onclick="return confirm('Bạn có chắc chắn muốn hủy ca sáng ngày @date.ToString("dd/MM/yyyy") không?')">
                                                                    <i class="bi bi-trash"></i> Hủy đăng ký
                                                                </button>
                                                            </form>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="empty-slot">
                                                            <div class="text-center mb-2">
                                                                <i class="bi bi-calendar-plus text-muted" style="font-size: 1.5rem;"></i>
                                                                <div class="text-muted small">Chưa đăng ký</div>
                                                            </div>
                                                            <form method="post" action="@Url.Action("RegisterSchedule")" class="w-100">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="roomId" value="@Model.RoomId" />
                                                                <input type="hidden" name="date" value="@date.ToString("yyyy-MM-dd")" />
                                                                <input type="hidden" name="period" value="morning" />
                                                                <input type="hidden" name="year" value="@Model.Year" />
                                                                <input type="hidden" name="week" value="@Model.Week" />
                                                                <input type="hidden" name="departmentId" value="@Model.DepartmentId" />
                                                                <button type="submit" class="btn btn-sm btn-success w-100">
                                                                    <i class="bi bi-plus-circle"></i> Đăng ký ca sáng
                                                                </button>
                                                            </form>
                                                        </div>
                                                    }
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                    
                                    <!-- Afternoon shift -->
                                    <tr>
                                        <td class="fw-bold bg-light text-center">
                                            <div>Ca chiều</div>
                                            <small class="text-muted">13:00 - 17:00</small>
                                        </td>
                                        @foreach (var date in weekDates)
                                        {
                                            <td class="text-center">
                                                @{
                                                    var afternoonSlots = Model.WeeklySchedule.TryGetValue(date.Date, out var slotsAfternoon) 
                                                        ? slotsAfternoon.Where(s => s.Period == "afternoon").ToList() 
                                                        : new List<MediAppointment.Client.Models.DoctorSchedule.ScheduleSlot>();
                                                }
                                                
                                                <div class="schedule-cell" data-date="@date.ToString("yyyy-MM-dd")" data-period="afternoon">
                                                    @if (afternoonSlots.Any())
                                                    {
                                                        <div class="registered-slots">
                                                            <div class="text-center mb-3">
                                                                <span class="badge bg-success" style="font-size: 1rem; padding: 8px 12px;">
                                                                    <i class="bi bi-check-circle-fill"></i> Đã đăng ký
                                                                </span>
                                                            </div>
                                                            <form method="post" action="@Url.Action("CancelSchedule")" class="w-100">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="roomId" value="@Model.RoomId" />
                                                                <input type="hidden" name="date" value="@date.ToString("yyyy-MM-dd")" />
                                                                <input type="hidden" name="period" value="afternoon" />
                                                                <input type="hidden" name="year" value="@Model.Year" />
                                                                <input type="hidden" name="week" value="@Model.Week" />
                                                                <input type="hidden" name="departmentId" value="@Model.DepartmentId" />
                                                                <button type="submit" class="btn btn-sm btn-outline-danger w-100"
                                                                        onclick="return confirm('Bạn có chắc chắn muốn hủy ca chiều ngày @date.ToString("dd/MM/yyyy") không?')">
                                                                    <i class="bi bi-trash"></i> Hủy đăng ký
                                                                </button>
                                                            </form>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="empty-slot">
                                                            <div class="text-center mb-2">
                                                                <i class="bi bi-calendar-plus text-muted" style="font-size: 1.5rem;"></i>
                                                                <div class="text-muted small">Chưa đăng ký</div>
                                                            </div>
                                                            <form method="post" action="@Url.Action("RegisterSchedule")" class="w-100">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="roomId" value="@Model.RoomId" />
                                                                <input type="hidden" name="date" value="@date.ToString("yyyy-MM-dd")" />
                                                                <input type="hidden" name="period" value="afternoon" />
                                                                <input type="hidden" name="year" value="@Model.Year" />
                                                                <input type="hidden" name="week" value="@Model.Week" />
                                                                <input type="hidden" name="departmentId" value="@Model.DepartmentId" />
                                                                <button type="submit" class="btn btn-sm btn-success w-100">
                                                                    <i class="bi bi-plus-circle"></i> Đăng ký ca chiều
                                                                </button>
                                                            </form>
                                                        </div>
                                                    }
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Advanced Schedule Actions -->
                        @if (Model.RoomId != Guid.Empty && Model.DepartmentId != Guid.Empty)
                        {
                            @await Html.PartialAsync("_AdvancedScheduleActions", Model)
                        }
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            Vui lòng chọn khoa, phòng, năm và tuần để xem lịch làm việc.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Form control height matching */
.form-select, .btn {
    height: 38px !important;
    line-height: 1.5;
}

.btn {
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    min-width: 0;
}

.btn i {
    margin-right: 4px;
}

/* Responsive adjustments */
@@media (max-width: 991px) {
    .col-md-2, .col-md-4 {
        margin-bottom: 1rem;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .d-flex.gap-2 button {
        width: 100%;
    }
}

@@media (max-width: 768px) {
    .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
    
    .btn i {
        font-size: 0.875rem;
    }
}

.schedule-cell {
    min-height: 80px;
    padding: 10px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.schedule-cell:hover {
    background-color: #f8f9fa;
}

.registered-slots {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #28a745;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.1);
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 120px;
}

.empty-slot {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 12px;
    border-radius: 8px;
    border: 2px dashed #6c757d;
    text-align: center;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: all 0.3s ease;
}

.empty-slot:hover {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(33, 150, 243, 0.15);
}

.time-slot-option {
    margin-bottom: 10px;
}

.time-slot-checkbox {
    cursor: pointer;
}

.time-slot-checkbox:checked + label {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    color: white;
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

.form-check-label {
    transition: all 0.3s ease;
    cursor: pointer;
}

.form-check-label:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.btn {
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-outline-success:hover {
    transform: scale(1.05);
}

.btn-outline-danger:hover {
    transform: scale(1.05);
}

.table {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.table th {
    border-top: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
}

.table td {
    vertical-align: middle;
    border-color: #e9ecef;
}

.alert {
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-select, .form-control {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-select:focus, .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    transform: scale(1.02);
}

.modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
}

.modal-header {
    border-radius: 12px 12px 0 0;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-bottom: none;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
    border-radius: 0 0 12px 12px;
}

.list-group-item {
    border-radius: 8px !important;
    margin-bottom: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    transform: translateX(4px);
    border-color: #007bff;
}

.list-group-item.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-color: #007bff;
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

.badge {
    border-radius: 6px;
    font-weight: 500;
}

/* Loading animation */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Responsive improvements */
@@media (max-width: 768px) {
    .schedule-cell {
        min-height: 60px;
        padding: 6px;
    }
    
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .table {
        font-size: 0.875rem;
    }
    
    .form-select, .form-control {
        font-size: 0.875rem;
    }
}

/* Success/Error states */
.schedule-success {
    animation: pulse-success 2s ease-in-out;
}

.schedule-error {
    animation: pulse-error 2s ease-in-out;
}

@@keyframes pulse-success {
    0%, 100% { background-color: transparent; }
    50% { background-color: rgba(25, 135, 84, 0.1); }
}

@@keyframes pulse-error {
    0%, 100% { background-color: transparent; }
    50% { background-color: rgba(220, 53, 69, 0.1); }
}

/* Custom scrollbar */
.modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #007bff;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #0056b3;
}
</style>

@* Include Simplified JavaScript file for validation and UX enhancements only *@
<script src="~/js/doctor-schedule-simplified.js"></script>
